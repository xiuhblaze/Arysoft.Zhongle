

@using Arysoft.ProyectoN.Models;

@{ 
    //string IDs = string.Empty;

    //foreach (AuditoriaPersona item in Model)
    //{
    //    IDs += item.AuditoriaPersonaID.ToString() + ",";
    //}

    //if (!string.IsNullOrEmpty(IDs))
    //{
    //    IDs = IDs.Substring(0, IDs.Length - 1);
    //}

    var resultadoList = Enum.GetValues(typeof(AuditoriaResultadoTipo))
        .Cast<AuditoriaResultadoTipo>()
        .Select(e => new SelectListItem
        {
            Value = e.ToString(),
            Text = e.GetDisplayName()
        });
}

<div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
    <h4 class="modal-title">
        Auditoria <small>DETALLES DE LA PERSONA</small>
    </h4>
</div>

<div class="modal-body">

    <p class="lead">Información aplicada a las personas seleccionadas.</p>

    <div class="well">
        <div class="form-horizontal">
            <div class="form-group">
                <label class="col-md-3 control-label">Auditoria realizada el</label>
                <div class="col-md-3">
                    <input type="date" id="auditoriaPersonaFecha" name="auditoriaPersonaFecha" class="form-control" placeholder="dd/mm/aaaa" />
                </div>
                <label class="col-md-3 control-label">Sigue siendo votante seguro?</label>
                <div class="col-md-3">
                    <input type="checkbox" value="SI" id="auditoriaPersonaVotanteSeguro" name="auditoriaPersonaVotanteSeguro" data-reverse checked />
                </div>
            </div>
            <div class="form-group">
                <label class="col-md-3 control-label">Resultado</label>
                <div class="col-md-9">
                    @Html.DropDownList("resultado", resultadoList, htmlAttributes: new { @class = "form-control" })
                </div>
            </div>
            <div class="form-group">
                <label class="col-md-3 control-label">Observaciones</label>
                <div class="col-md-9">
                    <textarea id="auditoriaPersonaObservaciones" name="auditoriaPersonaObservaciones" class="form-control" placeholder="Comentarios particulares a esta persona auditada"></textarea>
                </div>
            </div>
        </div>
    </div>

</div>

<div class="modal-footer">
    <div class="row">
        <div class="col-md-8 text-left text-muted">

        </div>
        <div class="col-md-4 text-right">
            <button type="button" class="btn btn-default" data-dismiss="modal">
                <span class="glyphicon glyphicon-remove"></span>
                Cancelar
            </button>
            <button id="auditoriaPersonaGuardarButton" name="auditoriaPersonaGuardarButton" class="btn btn-primary">
                <span class="glyphicon glyphicon-floppy-disk" title="Guardar"></span>
                Guardar
            </button>
        </div>
    </div>
</div>

<script>

    $(document).ready(function () {

        $('#auditoriaPersonaVotanteSeguro').checkboxpicker({
            offLabel: 'no',
            onLabel: 'si'
        });

        $('#auditoriaPersonaGuardarButton').on('click', function () {
            var url = '@Url.Action("EditarPersonas", "Auditoria")';
            var ids = '';
            var observaciones = $('#auditoriaPersonaObservaciones').val();
            var fecha = $('#auditoriaPersonaFecha').val();
            var votanteSeguro = $('#auditoriaPersonaVotanteSeguro').is(':checked') ? '@BoolTipo.Si' : '@BoolTipo.No';
            var resultado = $('#resultado').val();
            //TODO: Validar que vayan todos los datos
            
            $('input[name=personaSeleccionadaEdit]:checked').each(function () {
                ids += $(this).val() + ',';
            });
            
            $.ajax({
                cache: false,
                async: true,
                type: 'post',
                url: url,
                data: {
                    ids: ids,
                    observaciones: observaciones,
                    votanteSeguro: votanteSeguro,
                    fecha: fecha,
                    resultado: resultado
                },
                beforeSend: function() {
                    $('#auditoriaPersonaGuardarButton').html('<span class="glyphicon glyphicon-floppy-disk" title="Guardando cambios"></span> Guardando...');
                },
                success: function (vista) {
                    switch (vista) {
                        case "notids":
                            alert('No se recibieron identificadores de personas');
                            $('#auditoriaPersonaGuardarButton').html('<span class="glyphicon glyphicon-floppy-disk" title="Guardar"></span> Guardar');
                            break;
                        case "notfound":
                            alert('No se encontró la persona asociada a la auditoria solicitada');
                            $('#auditoriaPersonaGuardarButton').html('<span class="glyphicon glyphicon-floppy-disk" title="Guardar"></span> Guardar');
                            break;
                        default:
                            $('#listaPersonas').html(vista);
                            $('#agregarPersonasModal').modal('hide');
                            break;
                    }                    
                },
                error: function (xhr, status, error) {
                    alert('A ocurrido una excepción: ' + error);
                    $('#auditoriaPersonaGuardarButton').html('<span class="glyphicon glyphicon-floppy-disk" title="Guardar"></span> Guardar');
                }
            });

        }); // auditoriaPersonaGuardarButton.click

    }); // document.ready

</script>